---
{}
---

import { RuleID } from "~/components";

The following example deploys a [WAF managed ruleset](/waf/managed-rules/#managed-rulesets) to the `http_request_firewall_managed` phase of a given zone (`{zone_id}`).

1.  Search for an existing [entry point ruleset](/ruleset-engine/about/rulesets/#entry-point-ruleset) for the `http_request_firewall_managed` phase using the [List zone rulesets](/api/operations/listZoneRulesets) operation and take note of the ruleset ID. This ruleset, if it exists, has the following properties: `"kind": "zone"` and `"phase": "http_request_firewall_managed"`.

    ```bash
    curl "https://api.cloudflare.com/client/v4/zones/{zone_id}/rulesets" \
    --header "Authorization: Bearer <API_TOKEN>"
    ```

    ```json output {5,9,12}
    {
    	"result": [
    		// ...
    		{
    			"id": "<RULESET_ID>",
    			"name": "default",
    			"description": "",
    			"source": "firewall_managed",
    			"kind": "zone",
    			"version": "5",
    			"last_updated": "2024-07-22T16:04:19.788697Z",
    			"phase": "http_request_firewall_managed"
    		}
    		// ...
    	],
    	"success": true,
    	"errors": [],
    	"messages": []
    }
    ```

2.  If the entry point ruleset does not exist (the previous command returned a `404 Not Found` status code), create it using the [Create a zone ruleset](/api/operations/createZoneRuleset) operation. Include a single rule in the `rules` array that executes the [Cloudflare Managed Ruleset](/waf/managed-rules/reference/cloudflare-managed-ruleset/) (with ID <RuleID id="efb7b8c949ac4650a09736fc376e9aee" />) for all incoming requests in the zone.

    ```bash
    curl "https://api.cloudflare.com/client/v4/zones/{zone_id}/rulesets" \
    --header "Authorization: Bearer <API_TOKEN>" \
    --header "Content-Type: application/json" \
    --data '{
      "name": "My ruleset",
      "description": "Entry point ruleset for WAF managed rulesets",
      "kind": "zone",
      "phase": "http_request_firewall_managed",
      "rules": [
        {
    			"action": "execute",
    			"action_parameters": {
    				"id": "efb7b8c949ac4650a09736fc376e9aee"
    			},
    			"expression": "true",
    			"description": "Execute the Cloudflare Managed Ruleset"
    		}
      ]
    }'
    ```

    If the entry point ruleset already exists, add a rule to this ruleset (with ID `{ruleset_id}`) using the [Create a zone ruleset rule](/api/operations/createZoneRulesetRule) operation. This rule executes the Cloudflare Managed Ruleset (with ID <RuleID id="efb7b8c949ac4650a09736fc376e9aee" />) for all incoming requests in the zone.

    ```bash
    curl --request PUT \
    "https://api.cloudflare.com/client/v4/zones/{zone_id}/rulesets/{ruleset_id}/rules" \
    --header "Authorization: Bearer <API_TOKEN>" \
    --header "Content-Type: application/json" \
    --data '{
    	"action": "execute",
    	"action_parameters": {
    		"id": "efb7b8c949ac4650a09736fc376e9aee"
    	},
    	"expression": "true",
    	"description": "Execute the Cloudflare Managed Ruleset"
    }'
    ```

    ```json output
    {
    	"result": {
    		"id": "<RULESET_ID>",
    		"name": "Zone-level phase entry point",
    		"description": "",
    		"kind": "zone",
    		"version": "3",
    		"rules": [
    			// ... any existing rules
    			{
    				"id": "<RULE_ID>",
    				"version": "1",
    				"action": "execute",
    				"action_parameters": {
    					"id": "efb7b8c949ac4650a09736fc376e9aee",
    					"version": "latest"
    				},
    				"expression": "true",
    				"description": "Execute the Cloudflare Managed Ruleset",
    				"last_updated": "2024-03-18T18:08:14.003361Z",
    				"ref": "<RULE_REF>",
    				"enabled": true
    			}
    		],
    		"last_updated": "2024-03-18T18:08:14.003361Z",
    		"phase": "http_request_firewall_managed"
    	},
    	"success": true,
    	"errors": [],
    	"messages": []
    }
    ```
