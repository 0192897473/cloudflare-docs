---
pcx_content_type: how-to
title: Deploy a managed ruleset
sidebar:
  order: 2
---

import { RuleID } from "~/components";

You can deploy a managed ruleset at the zone level or at the account level.

To deploy a managed ruleset to a phase, use the [Rulesets API](/ruleset-engine/rulesets-api/).

## Deploy a managed ruleset to a phase at the zone level

Use the following workflow to deploy a managed ruleset to a phase at the zone level.

1. Get your [zone ID](/fundamentals/setup/find-account-and-zone-ids/).
2. Invoke the [List account rulesets](/api/operations/listAccountRulesets) operation to obtain the available managed rulesets. Managed rulesets exist at the account level, but you can deploy them to a zone. Find the ruleset ID of the managed ruleset you want to deploy.
3. Identify the [phase](/ruleset-engine/about/phases/) where you want to deploy the managed ruleset. Ensure that the managed ruleset belongs to the same phase where you want to deploy it. To learn more about the available phases supported by each Cloudflare product, refer to the specific documentation for that product, or the [Phases list](/ruleset-engine/reference/phases-list/).
4. Add a rule to the zone-level phase [entry point ruleset](/ruleset-engine/about/rulesets/#entry-point-ruleset) that executes the managed ruleset. Refer to the following example for details on this step.

### Example

The following example deploys a WAF managed ruleset to the `http_request_firewall_managed` phase of a given zone (`{zone_id}`).

1.  Search for an existing [entry point ruleset](/ruleset-engine/about/rulesets/#entry-point-ruleset) for the `http_request_firewall_managed` phase using the [List zone rulesets](/api/operations/listZoneRulesets) operation and take note of the ruleset ID. This ruleset, if it exists, has the following properties: `"kind": "zone"` and `"phase": "http_request_firewall_managed"`.

    ```bash
    curl "https://api.cloudflare.com/client/v4/zones/{zone_id}/rulesets" \
    --header "Authorization: Bearer <API_TOKEN>"
    ```

    ```json output {5,9,12}
    {
    	"result": [
    		// ...
    		{
    			"id": "<RULESET_ID>",
    			"name": "default",
    			"description": "",
    			"source": "firewall_managed",
    			"kind": "zone",
    			"version": "5",
    			"last_updated": "2024-07-22T16:04:19.788697Z",
    			"phase": "http_request_firewall_managed"
    		}
    		// ...
    	],
    	"success": true,
    	"errors": [],
    	"messages": []
    }
    ```

2.  If the entry point ruleset does not exist (the previous command returned a `404 Not Found` status code), create it using the [Create a zone ruleset](/api/operations/createZoneRuleset) operation. Include a single rule in the `rules` array that executes the [Cloudflare Managed Ruleset](/waf/managed-rules/reference/cloudflare-managed-ruleset/) (with ID <RuleID id="efb7b8c949ac4650a09736fc376e9aee" />) for all incoming requests in the zone.

    ```bash
    curl "https://api.cloudflare.com/client/v4/zones/{zone_id}/rulesets" \
    --header "Authorization: Bearer <API_TOKEN>" \
    --header "Content-Type: application/json" \
    --data '{
      "name": "My ruleset",
      "description": "Entry point ruleset for WAF managed rulesets",
      "kind": "zone",
      "phase": "http_request_firewall_managed",
      "rules": [
        {
    			"action": "execute",
    			"action_parameters": {
    				"id": "efb7b8c949ac4650a09736fc376e9aee"
    			},
    			"expression": "true",
    			"description": "Execute the Cloudflare Managed Ruleset"
    		}
      ]
    }'
    ```

    If the entry point ruleset already exists, add a rule to this ruleset (with ID `{ruleset_id}`) using the [Create a zone ruleset rule](/api/operations/createZoneRulesetRule) operation. This rule executes the Cloudflare Managed Ruleset (with ID <RuleID id="efb7b8c949ac4650a09736fc376e9aee" />) for all incoming requests in the zone.

    ```bash
    curl --request PUT \
    "https://api.cloudflare.com/client/v4/zones/{zone_id}/rulesets/{ruleset_id}/rules" \
    --header "Authorization: Bearer <API_TOKEN>" \
    --header "Content-Type: application/json" \
    --data '{
    	"action": "execute",
    	"action_parameters": {
    		"id": "efb7b8c949ac4650a09736fc376e9aee"
    	},
    	"expression": "true",
    	"description": "Execute the Cloudflare Managed Ruleset"
    }'
    ```

    ```json output
    {
    	"result": {
    		"id": "<RULESET_ID>",
    		"name": "Zone-level phase entry point",
    		"description": "",
    		"kind": "zone",
    		"version": "3",
    		"rules": [
    			// ... any existing rules
    			{
    				"id": "<RULE_ID>",
    				"version": "1",
    				"action": "execute",
    				"action_parameters": {
    					"id": "efb7b8c949ac4650a09736fc376e9aee",
    					"version": "latest"
    				},
    				"expression": "true",
    				"description": "Execute the Cloudflare Managed Ruleset",
    				"last_updated": "2024-03-18T18:08:14.003361Z",
    				"ref": "<RULE_REF>",
    				"enabled": true
    			}
    		],
    		"last_updated": "2024-03-18T18:08:14.003361Z",
    		"phase": "http_request_firewall_managed"
    	},
    	"success": true,
    	"errors": [],
    	"messages": []
    }
    ```

In this example, the managed ruleset executes the behavior configured by Cloudflare. To customize the behavior of managed rulesets, refer to [Override a managed ruleset](/ruleset-engine/managed-rulesets/override-managed-ruleset/).

## Deploy a managed ruleset to a phase at the account level

Use the following workflow to deploy a managed ruleset to a phase at the account level.

1. Get your [account ID](/fundamentals/setup/find-account-and-zone-ids/).
2. Invoke the [List account rulesets](/api/operations/listAccountRulesets) operation to obtain the available managed rulesets. Find the ruleset ID of the managed ruleset you want to deploy.
3. Identify the [phase](/ruleset-engine/about/phases/) where you want to deploy the managed ruleset. Ensure that the managed ruleset belongs to the same phase where you want to deploy it. To learn more about the available phases supported by each Cloudflare product, refer to the specific documentation for that product, or the [Phases list](/ruleset-engine/reference/phases-list/).
4. Add a rule to the account-level phase [entry point ruleset](/ruleset-engine/about/rulesets/#entry-point-ruleset) that executes the managed ruleset. Use parentheses to enclose any custom conditions in the rule expression and end your expression with `and cf.zone.plan eq "ENT"` so that it only applies to zones on an Enterprise plan. Refer to the following example for details on this step.

### Example

The following example deploys a WAF managed ruleset to the `http_request_firewall_managed` phase of a given account (`{account_id}`) by creating a rule that executes the managed ruleset. The rules in the managed ruleset are executed when the zone name matches one of `example.com` or `anotherexample.com`.

1.  Search for an existing [entry point ruleset](/ruleset-engine/about/rulesets/#entry-point-ruleset) for the `http_request_firewall_managed` phase using the [List account rulesets](/api/operations/listAccountRulesets) operation and take note of the ruleset ID. This ruleset, if it exists, has the following properties: `"kind": "root"` and `"phase": "http_request_firewall_managed"`.

    ```bash
    curl "https://api.cloudflare.com/client/v4/account/{account_id}/rulesets" \
    --header "Authorization: Bearer <API_TOKEN>"
    ```

    ```json output {5,9,12}
    {
    	"result": [
    		// ...
    		{
    			"id": "<RULESET_ID>",
    			"name": "default",
    			"description": "",
    			"source": "firewall_managed",
    			"kind": "root",
    			"version": "5",
    			"last_updated": "2024-07-22T16:04:19.788697Z",
    			"phase": "http_request_firewall_managed"
    		}
    		// ...
    	],
    	"success": true,
    	"errors": [],
    	"messages": []
    }
    ```

2.  If the entry point ruleset does not exist (the previous command returned a `404 Not Found` status code), create it using the [Create an account ruleset](/api/operations/createAccountRuleset) operation. Include a single rule in the `rules` array that executes the [Cloudflare Managed Ruleset](/waf/managed-rules/reference/cloudflare-managed-ruleset/) (with ID <RuleID id="efb7b8c949ac4650a09736fc376e9aee" />) for all incoming requests where the zone name matches one of `example.com` or `anotherexample.com`.

    ```bash
    curl --request PUT \
    "https://api.cloudflare.com/client/v4/accounts/{account_id}/rulesets" \
    --header "Authorization: Bearer <API_TOKEN>" \
    --header "Content-Type: application/json" \
    --data '{
      "name": "My ruleset",
      "description": "Entry point ruleset for WAF managed rulesets",
      "kind": "root",
      "phase": "http_request_firewall_managed",
      "rules": [
        {
          "action": "execute",
          "action_parameters": {
            "id": "efb7b8c949ac4650a09736fc376e9aee"
          },
          "expression": "(cf.zone.name in {\"example.com\" \"anotherexample.com\"}) and cf.zone.plan eq \"ENT\"",
          "description": "Execute Cloudflare Managed Ruleset"
        }
      ]
    }'
    ```

        If the entry point ruleset already exists, add a rule to this ruleset (with ID `{ruleset_id}`) using the [Create an account ruleset rule](/api/operations/createAccountRulesetRule) operation. This rule executes the Cloudflare Managed Ruleset (with ID <RuleID id="efb7b8c949ac4650a09736fc376e9aee" />) for all incoming requests where the zone name matches one of `example.com` or `anotherexample.com`.

    ```bash
    curl --request PUT \
    "https://api.cloudflare.com/client/v4/accounts/{account_id}/rulesets/{ruleset_id}/rules" \
    --header "Authorization: Bearer <API_TOKEN>" \
    --header "Content-Type: application/json" \
    --data '{
    	"action": "execute",
    	"action_parameters": {
    		"id": "efb7b8c949ac4650a09736fc376e9aee"
    	},
    	"expression": "true",
    	"description": "Execute the Cloudflare Managed Ruleset"
    }'
    ```

    ```json output
    {
    	"result": {
    		"id": "<RULESET_ID>",
    		"name": "Account-level phase entry point",
    		"description": "",
    		"kind": "root",
    		"version": "3",
    		"rules": [
    			// ... any existing rules
    			{
    				"id": "<RULE_ID>",
    				"version": "1",
    				"action": "execute",
    				"action_parameters": {
    					"id": "efb7b8c949ac4650a09736fc376e9aee",
    					"version": "latest"
    				},
    				"expression": "(cf.zone.name in {\"example.com\" \"anotherexample.com\"}) and cf.zone.plan eq \"ENT\"",
    				"description": "Execute Cloudflare Managed Ruleset",
    				"last_updated": "2024-03-18T18:30:08.122758Z",
    				"ref": "<RULE_REF>",
    				"enabled": true
    			}
    		],
    		"last_updated": "2024-03-18T18:30:08.122758Z",
    		"phase": "http_request_firewall_managed"
    	},
    	"success": true,
    	"errors": [],
    	"messages": []
    }
    ```

    :::caution
    Managed rulesets deployed at the account level will only apply to incoming traffic of zones on an Enterprise plan. The expression of your `execute` rule must end with `and cf.zone.plan eq "ENT"` or else the API operation will fail.
    :::

In this example, the managed ruleset executes the behavior configured by Cloudflare. To customize the behavior of managed rulesets, refer to [Override a managed ruleset](/ruleset-engine/managed-rulesets/override-managed-ruleset/).
